# Deep Research Handoff – 30 Oct 2025

## 1. Current Mission Snapshot
- **Branch**: `feature/supervisor-flow` (uncommitted changes present)
- **Primary Objective**: Harden the Deep Research pipeline after the Priority 1 fix cycle; validation reruns (Lockheed + JSOC) completed 30 Oct.
- **Context Source of Truth**: Permanent operating doctrine lives in `CLAUDE_PERMANENT.md:1` (must read before coding).

## 2. System Architecture Primer
- **Deep Research Engine** (`research/deep_research.py:1`):
  - MCP-enabled task engine with adaptive relevance (`research/deep_research.py:263` & `research/deep_research.py:1136`).
  - Execution logging wired through `ExecutionLogger` (`research/deep_research.py:340`, `research/execution_logger.py:18`).
  - LLM-driven source selection for MCP + Brave web (`research/deep_research.py:662` onward).
- **Source Integrations**:
  - MCP tool wrappers under `integrations/mcp/` (government + social).
  - Discord export ingestion hardened via `_sanitize_json()` (`integrations/social/discord_integration.py:239`).
- **Logging & Analysis**:
  - JSONL execution traces plus raw payload archiving (`research/execution_logger.py:42` & `research/execution_logger.py:74`).
  - CLI analysis helper `scripts/analyze_execution_log.py:1` supports task/source filtering.
- **Operational Docs**:
  - Production posture summarized in `DEEP_RESEARCH_PRODUCTION_STATUS.md:1`.
  - Validation narratives in `PRIORITY_1_FIXES_VALIDATION_RESULTS_FINAL.md:1`.
  - Outstanding critique / test design captured in `TEST_QUERY_CRITIQUE.md:1` and `docs/SOURCE_VALIDATION_QUERIES.md:1`.

## 3. Summary of Completed Work (This Cycle)
- **Execution Logging**: Full trace logging now active for every run, producing `execution_log.jsonl` and `raw/` artifacts per research ID (`research/execution_logger.py:25` → `research/deep_research.py:340`).
- **Adaptive Relevance Thresholds**: Sensitive keywords trigger 1/10 tolerance, preventing false negatives on high-secrecy queries (`research/deep_research.py:263`, `research_deep_research.py:1138`).
- **Discord Parsing Reliability**: Sanitization + lenient decoding parses 5,226/5,235 exports (99.83%); 9 hard-corrupt files log warnings and are skipped (`integrations/social/discord_integration.py:239` → `integrations/social/discord_integration.py:332`).
- **Parallelism Increase**: Default concurrency raised to four simultaneous tasks to cut runtime (`research/deep_research.py:124`).
- **Lockheed Classified-Contract Retest**: CONFIRMED improvement (3/5 tasks succeed, 118 results) documented in `PRIORITY_1_FIXES_VALIDATION_RESULTS_FINAL.md:1`.
- **JSOC Syria Validation**: Completed successfully (5/5 tasks, 166 results, 5.3 min) with artifacts captured in `/tmp/query2_validation_parallelism_proper.log` and `data/research_output/<timestamp>/`.
- **Task-Start Logging**: Instrumented `_execute_task_with_retry()` to emit `task_start` events; verified via sanity run (`data/research_output/2025-10-31_03-05-12_what_is_dvids/execution_log.jsonl`).

## 4. Outstanding Work & Decisions
1. **Documentation Synchronisation (HIGH)**  
   - Keep `PRIORITY_1_FIXES_VALIDATION_RESULTS_FINAL.md`, `STATUS.md:1`, and `TEST_QUERY_CRITIQUE.md:1` aligned as further validation occurs.  
   - Note: Updates reflecting 30 Oct reruns already landed.
2. **Optional – Additional Logging Enhancements (MEDIUM)**  
   - Assess need for further instrumentation (e.g., per-source timing) in `research/deep_research.py`.  
   - Capture decisions in `research/EXECUTION_LOGGING_RISKS_ANALYSIS.md:1`.
3. **Future Validation Coverage (LOW)**  
   - Use `docs/SOURCE_VALIDATION_QUERIES.md:1` to schedule per-source checks once JSOC run passes.

## 5. Testing & Validation Status
- **Completed**: Lockheed classified-contracts query passes with adaptive thresholds (`PRIORITY_1_FIXES_VALIDATION_RESULTS_FINAL.md:20`).  
- **Completed**: JSOC Syria query rerun succeeds with 4-task parallel batches (see `PRIORITY_1_FIXES_VALIDATION_RESULTS_FINAL.md:130` and `/tmp/query2_validation_parallelism_proper.log`).  
- **Completed**: Task-start logging sanity run captured in `data/research_output/2025-10-31_03-05-12_what_is_dvids/`.  
- **Gaps**:
  - No automated regression for Discord export parsing (manual validation only). Flag in backlog.  
  - High concurrency untested against rate limits for all APIs—monitor SAM.gov warnings during upcoming runs.

## 6. Operational Playbook
1. **Environment Setup**  
   - Activate venv before scripts: `source .venv/bin/activate`.  
   - Required secrets stored in `.env` (OPENAI, Brave, DVIDS, etc.). Do **not** commit the file.
2. **Executing Deep Research Manually**  
   - Example: `python3 research/deep_research_cli.py "QUESTION"` (CLI runner, adjust if alternate script).  
   - Outputs saved under `data/research_output/<timestamp_slug>/` when `save_output=True`.
3. **Inspecting Logs**  
   - Tail structured log: `tail -f data/research_output/.../execution_log.jsonl`.  
   - Analyze via helper: `python3 scripts/analyze_execution_log.py path --format summary`.
4. **Validation Workflow**  
   - Run target query.  
   - Capture stdout + log summary to `/tmp/` or repo doc.  
   - Update `PRIORITY_1_FIXES_VALIDATION_RESULTS_FINAL.md` and `STATUS.md`.  
   - Record open risks in `research/EXECUTION_LOGGING_RISKS_ANALYSIS.md:1` if new issues surface.

## 7. Known Risks & Edge Cases
- **SAM.gov Rate Limits**: Still frequent 429s; system treats as optional but keep messaging consistent (`research/deep_research.py:216`, `PRIORITY_1_FIXES_VALIDATION_RESULTS_FINAL.md:42`).  
- **Sensitive Keyword Coverage**: `_detect_query_sensitivity` list may miss emerging patterns—extend list when failures observed (`research/deep_research.py:276`).  
- **Discord “Hard Corrupt” Files**: ~0.2% remain unparseable; harmlessly skipped but log if volume increases (`integrations/social/discord_integration.py:327`).  
- **Concurrency vs Tool Limits**: Monitor for new throttling as `max_concurrent_tasks` rose to 4 (`research_deep_research.py:124`).

## 8. Reading Checklist for Next Agent
1. **Philosophy & Process** – `CLAUDE_PERMANENT.md:1` (operating mandates).  
2. **Engine Source** – `research/deep_research.py:1` (skim entire file; focus on logging, thresholds, source selection).  
3. **Execution Logger** – `research/execution_logger.py:1` (understand schema before emitting new actions).  
4. **Discord Integration** – `integrations/social/discord_integration.py:200` (sanitization + search pipeline).  
5. **Validation Results** – `PRIORITY_1_FIXES_VALIDATION_RESULTS_FINAL.md:1` (baseline for future comparisons).  
6. **Outstanding Issues** – `TEST_QUERY_CRITIQUE.md:1` and `docs/SOURCE_VALIDATION_QUERIES.md:1` (pending validation coverage).  
7. **Production Status** – `DEEP_RESEARCH_PRODUCTION_STATUS.md:1` (historical context).  
8. **Logging Analysis Tooling** – `scripts/analyze_execution_log.py:1`.  
9. **Execution Logging Risk Notes** – `research/EXECUTION_LOGGING_RISKS_ANALYSIS.md:1`.

## 9. Recommended Next Steps
1. Maintain documentation parity after future validation runs.  
2. Queue per-source validation plan (`docs/SOURCE_VALIDATION_QUERIES.md`) for broader coverage.  
3. Evaluate whether additional telemetry is needed beyond the new task-start events.

## 10. Contacts & Notes
- All prior session context captured in `CLAUDE.md` (TEMPORARY section). Review for nuanced directives.  
- Execution artifacts from the successful Lockheed rerun reside under `data/research_output/2025-10-30_14-18-11_what_classified_research_contracts_did_lockheed.../` (verify exact slug when needed).  
- Use caution editing large docs—maintain ASCII and follow commenting guidance.

**End of Handoff – proceed methodically, validate everything, and document new findings immediately.**
