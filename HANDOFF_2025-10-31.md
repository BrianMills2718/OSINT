# Deep Research Handoff – 31 Oct 2025 (Session Continuation)

## 1. Current Session Status
- **Branch**: `feature/supervisor-flow` (uncommitted changes)
- **Active Work**: Preparing to implement adaptive parameter refinement (Phases 2-6)
- **Baseline Commit**: `074f82a` (USAJobs fix + validation test results documented)
- **Implementation Plan**: Documented in `/home/brian/sam_gov/CLAUDE.md` TEMPORARY section
- **Validation Tests**: 6/7 baseline tests running in background (Test 2-8, Test 1 skipped per plan)

## 2. Immediate Context: Adaptive Parameter Refinement

### Goal
Enable LLM to adjust source-specific parameters (not just query text) based on result feedback. Example: If Reddit returns sparse results with `time_filter: "month"`, LLM suggests `time_filter: "year"` on retry.

### Implementation Status
**NOT STARTED** - Implementation paused for documentation update.

**Baseline Captured**:
- Commit `074f82a` with USAJobs fix (single broad keywords)
- Validation tests running in background (results not yet captured)
- Implementation plan in CLAUDE.md (Phases 1-8, estimated 2.5 hours)

**Next Step**: Complete validation test capture, then proceed with Phase 2 implementation.

### Implementation Phases (from CLAUDE.md)
1. ✅ **Phase 1: Commit Baseline** - COMPLETE (commit 074f82a)
2. ⏸️ **Phase 2: Modify Reformulation Methods** (45 min) - NOT STARTED
   - Location: `research/deep_research.py:1053-1115` (_reformulate_for_relevance, _reformulate_query_simple)
   - Change: Return `Dict[str, Any]` instead of `str`
   - New format: `{"query": "...", "param_adjustments": {"reddit": {"time_filter": "year"}}}`
3. ⏸️ **Phase 3: Update Retry Loop Call Sites** (30 min) - NOT STARTED
   - Location: `research/deep_research.py:662, 799`
   - Unpack reformulation response to get query + param_adjustments
4. ⏸️ **Phase 4: Extend MCP Wrapper** (30 min) - NOT STARTED
   - Location: `integrations/mcp/database_tools.py`
   - Add optional `param_hints` to search tools
5. ⏸️ **Phase 5: Update Reddit Integration** (20 min) - NOT STARTED
   - Location: `integrations/social/reddit_integration.py`
   - Accept `param_hints` in `generate_query()`
6. ⏸️ **Phase 6: Update USAJobs Integration** (25 min) - NOT STARTED
   - Location: `integrations/government/usajobs_integration.py`
   - Accept `param_hints` in `generate_query()`
7. ⏸️ **Phase 7: Test & Validate** (30 min) - NOT STARTED
   - Rerun Test 3 (USAJobs) and Test 6 (Reddit)
   - Compare against baseline (commit 074f82a)
8. ⏸️ **Phase 8: Commit or Revert** - NOT STARTED
   - If validation passes: `git commit -m "feat: Add adaptive parameter refinement"`
   - If validation fails: `git revert HEAD~1` to baseline

### Key Files to Modify
- `research/deep_research.py` (reformulation methods + retry loop)
- `integrations/mcp/database_tools.py` (MCP wrapper param_hints)
- `integrations/social/reddit_integration.py` (param_hints support)
- `integrations/government/usajobs_integration.py` (param_hints support)

## 3. Background Validation Tests (In Progress)

**Status**: 6 validation tests running in background bash shells since previous session.

**Tests Running**:
- Test 2 (DVIDS): `Bash b8114b`
- Test 3 (USAJobs): `Bash 68f553`  ← **KEY TEST for adaptive refinement**
- Test 4 (ClearanceJobs): `Bash c4789a`
- Test 5 (Twitter): `Bash 9a8aa2`
- Test 6 (Reddit): `Bash 310233`  ← **KEY TEST for adaptive refinement**
- Test 7 (Discord): `Bash 848476`
- Test 8 (Brave Search): `Bash 1a9483`

**Purpose**: Capture baseline performance BEFORE adaptive parameter refinement.

**Expected Baseline Findings** (from previous session):
- Test 3 (USAJobs): USAJobs MCP **NOT selected** by LLM (selected Brave Search instead)
  - Query: "What federal cybersecurity analyst positions are currently open in Washington DC?"
  - Validates need for adaptive refinement to help integrations succeed when selected
- Test 6 (Reddit): Low results (1 result legitimate, but `time_filter` could be adjusted)
  - Query: "What is the OSINT community discussing about Palantir's government contracts..."
  - Validates need for adaptive refinement to adjust `time_filter` from "month" to "year"

**Next Step**: Use `BashOutput` tool to check completion status and capture results.

## 4. Recent Work (Previous Session)

### Completed
1. **USAJobs Integration Fix** (commit 074f82a)
   - Modified prompt to prefer single broad keywords (e.g., "cybersecurity" vs "cybersecurity analyst")
   - Result: 21x improvement (1 → 21 results)
   - Location: `integrations/government/usajobs_integration.py:119-124`

2. **Implementation Plan Documentation**
   - Updated `CLAUDE.md` TEMPORARY section with full adaptive parameter refinement plan
   - Phases 1-8 detailed with file locations and estimated times

3. **Baseline Commit**
   - Commit `074f82a`: "feat(usajobs): Prefer single broad keywords for maximum results"
   - Includes USAJobs fix + updated CLAUDE.md
   - Baseline for before/after comparison

### Pending (THIS SESSION)
1. **Capture Validation Test Results**
   - Check status of 6 background bash shells
   - Document baseline results
   - Update todo list

2. **Implement Adaptive Parameter Refinement** (Phases 2-6)
   - Start with Phase 2: Modify reformulation methods
   - Estimated time: 2-2.5 hours for complete implementation

## 5. Critical Code Locations

### Reformulation Methods (Phase 2 Target)
**File**: `research/deep_research.py`

**Current Implementation** (lines 1053-1115):
```python
async def _reformulate_for_relevance(
    self,
    original_query: str,
    research_question: str,
    results_count: int
) -> str:  # ← Currently returns str, needs to return Dict
    """Reformulate query to get MORE RELEVANT results."""
    # ... LLM call ...
    return response.choices[0].message.content.strip().strip('"')

async def _reformulate_query_simple(self, original_query: str, results_count: int) -> str:  # ← Currently returns str
    """Reformulate query when it returns insufficient results."""
    # ... LLM call ...
    return response.choices[0].message.content.strip().strip('"')
```

**Required Change**:
- Change return type to `Dict[str, Any]`
- Add source-specific parameter guidance to LLM prompts
- Return format: `{"query": "new query", "param_adjustments": {"reddit": {"time_filter": "year"}}}`

**Call Sites** (Phase 3 Target):
- Line 662: `task.query = await self._reformulate_for_relevance(...)`
- Line 799: `task.query = await self._reformulate_query_simple(...)`

**Required Change**:
```python
# OLD:
task.query = await self._reformulate_for_relevance(...)

# NEW:
reformulation = await self._reformulate_for_relevance(...)
task.query = reformulation["query"]
param_adjustments = reformulation.get("param_adjustments", {})
# Pass param_adjustments to MCP tools
```

### Integration Updates (Phases 5-6 Target)

**Reddit Integration**: `integrations/social/reddit_integration.py`
- Need to accept `param_hints` in `generate_query(question, param_hints=None)`
- Merge hints with LLM-generated params (hints take precedence)

**USAJobs Integration**: `integrations/government/usajobs_integration.py`
- Need to accept `param_hints` in `generate_query(question, param_hints=None)`
- Merge hints with LLM-generated params (hints take precedence)

**MCP Wrapper**: `integrations/mcp/database_tools.py`
- Add optional `param_hints` argument to search tool
- Pass hints to integrations' `generate_query()` method

## 6. Rollback Strategy

**If validation fails after implementation**:
```bash
git revert HEAD  # Revert adaptive refinement commit
# This returns to commit 074f82a (USAJobs fix baseline)
```

**No feature flags** - Using git commits for rollback per user preference.

## 7. Documentation to Update (After Implementation)

1. **CLAUDE.md** TEMPORARY section
   - Update implementation status (mark phases as completed)
   - Document validation test results (before/after comparison)
   - Update next actions

2. **STATUS.md**
   - Add adaptive parameter refinement to feature list
   - Update integration status if validation passes

3. **HANDOFF document** (this file)
   - Update "Implementation Status" section
   - Document actual vs expected results

## 8. Operational Notes

### Environment
- Virtual environment: `.venv` (activate with `source .venv/bin/activate`)
- Required secrets in `.env` (OPENAI, Brave, DVIDS, USAJobs, SAM, etc.)

### Key Commands
```bash
# Check validation test status
# Use BashOutput tool with shell IDs: b8114b, 68f553, c4789a, 9a8aa2, 310233, 848476, 1a9483

# Run single test manually
source .venv/bin/activate
python3 -c "import asyncio; from research.deep_research import SimpleDeepResearch; ..."

# Git operations
git status                                # Check uncommitted changes
git diff research/deep_research.py        # Review changes
git add -A && git commit -m "message"     # Commit
git revert HEAD                            # Rollback if needed
```

### Testing Strategy
1. Capture baseline results from current validation tests
2. Implement adaptive refinement (Phases 2-6)
3. Rerun Test 3 (USAJobs) and Test 6 (Reddit)
4. Compare: Did param adjustments improve results?
5. Commit if successful, revert if not

## 9. Reading Checklist for Next Session

**Essential Files**:
1. `/home/brian/sam_gov/CLAUDE.md` - Current task context (TEMPORARY section)
2. `/home/brian/sam_gov/research/deep_research.py:1053-1115` - Reformulation methods
3. `/home/brian/sam_gov/integrations/government/usajobs_integration.py` - Fixed integration
4. `/home/brian/sam_gov/integrations/social/reddit_integration.py` - Target for param_hints
5. `/home/brian/sam_gov/docs/INTEGRATION_QUERY_GUIDES.md` - Query syntax documentation

**Context Documents**:
- `HANDOFF_2025-10-30.md` - Previous session handoff
- `PRIORITY_1_FIXES_VALIDATION_RESULTS_FINAL.md` - Validation baseline
- `docs/SOURCE_VALIDATION_QUERIES.md` - Test queries

## 10. Immediate Next Steps (Priority Order)

1. **[HIGH] Check Validation Test Status**
   - Use `BashOutput` tool to check all 6 background shells
   - Document baseline results
   - Save output directories for comparison

2. **[HIGH] Implement Phase 2: Modify Reformulation Methods**
   - Edit `research/deep_research.py:1053-1115`
   - Change return type from `str` to `Dict[str, Any]`
   - Add parameter guidance to LLM prompts
   - Test: Ensure no syntax errors

3. **[HIGH] Implement Phase 3: Update Retry Loop Call Sites**
   - Edit `research/deep_research.py:662, 799`
   - Unpack reformulation response
   - Pass param_adjustments to MCP tools

4. **[MEDIUM] Implement Phases 4-6: Update Integrations**
   - MCP wrapper (Phase 4)
   - Reddit integration (Phase 5)
   - USAJobs integration (Phase 6)

5. **[HIGH] Test & Validate (Phase 7)**
   - Rerun Test 3 (USAJobs) and Test 6 (Reddit)
   - Compare against baseline
   - Document improvements

6. **[HIGH] Commit or Revert (Phase 8)**
   - If validation passes: Commit with descriptive message
   - If validation fails: Revert to baseline (074f82a)

## 11. Known Constraints

- **Context Budget**: 200K tokens, currently ~114K used (~57%)
- **Implementation Time**: 2-2.5 hours estimated for Phases 2-6
- **No Partial Commits**: Entire adaptive refinement must work before committing
- **Validation Required**: Must prove improvement before accepting changes

**End of Handoff – Resume with validation test status check, then proceed with Phase 2 implementation if tests complete successfully.**
